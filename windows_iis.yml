---
- name: install iis
  win_feature:
    name: Web-Server
    state: present
    include_sub_features: yes
    include_management_tools: yes
  notify: iis_running

- name: Insert webpage formatting
  win_copy:
    src: website/
    dest: C:\Inetpub\wwwroot\

- name: Insert Index Page for webpage
  win_template:
    src: templates/indexcomplex.html.j2
    dest: C:\Inetpub\wwwroot\index.html
  tags:
    - updatewin   

- name: Configure site
  win_iis_website:
    name: 'Ansible Tower'
    physical_path: 'C:\inetpub\wwwroot'
    port: 80
    ssl: true
  notify: iis_running

- name: Copy Cert
  win_copy:
    src: /certs/web_cert/cert.pfx
    dest: "%TEMP%\\{{ cert_name }}.pfx"

- name: Copy Powershell Binding Template
  win_template:
    src: update-cert.ps1.j2
    dest: "%TEMP%\\update-cert.ps1"

- name: Bind Certificate
  win_command:
    'cmd /C cd %TEMP% && powershell.exe -ExecutionPolicy ByPass -File update-cert.ps1'

- name: iis_running
  win_service:
    name: W3Svc
    state: restarted